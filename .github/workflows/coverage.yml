name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        
    - name: Generate coverage
      run: |
        make clean
        make coverage || echo "No tests available yet"
        
    - name: Create coverage report directory
      run: mkdir -p coverage_report
        
    - name: Create basic coverage report
      run: |
        echo "<html><body><h1>Coverage Report</h1><p>No tests available yet.</p></body></html>" > coverage_report/index.html
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_report/
        
    - name: Generate coverage badge
      if: github.ref == 'refs/heads/main'
      run: |
        COVERAGE=$(lcov --summary coverage.info | grep "lines" | awk '{print $4}' | cut -d'%' -f1)
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "::set-output name=coverage::$COVERAGE"
        
    - name: Update coverage badge
      if: github.ref == 'refs/heads/main'
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: coverage.json
        label: coverage
        message: ${{ steps.coverage.outputs.coverage }}%
        color: ${{ steps.coverage.outputs.coverage > 80 && 'success' || steps.coverage.outputs.coverage > 60 && 'warning' || 'critical' }} 